!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r():"function"==typeof define&&define.amd?define(r):r()}(0,function(){"use strict";function iterator(e){var r=0,t=1,s=1;return{curr:(t=0)=>e[r+t],end:()=>e.length<=r,info:()=>({index:r,col:t,line:s}),index:e=>void 0===e?r:r=e,next:()=>{var n=e[r++];return"\n"==n?(s++,t=0):t++,n}}}function throw_error(e,{col:r,line:t}){throw new Error(`(at line ${t}, column ${r}) ${e}`)}function get_text_value(e){return e.trim().length?is.number(+e)?+e:e.trim():e}function skip_block(e){var[r,t]=[e.curr(),e.curr()],s=is.close_bracket_of(t);for(e.next();!e.end();){if(s(t=e.curr())){r+=t;break}is.open_bracket(t)?r+=skip_block(e):r+=t,e.next()}return r}function read_until(e){return function(r,t){for(var s=r.index(),n="";!r.end();){var i=r.next();if(e(i))break;n+=i}return t&&r.index(s),n}}function read_word(e,r){return read_until(e=>is.white_space(e))(e,r)}function read_line(e,r){return read_until(e=>is.line_break(e))(e,r)}function read_step(e){for(var r,t=Tokens.step();!e.end()&&"}"!=(r=e.curr());)if(is.white_space(r))e.next();else{if(t.name.length){if(t.styles.push(read_rule(e)),"}"==e.curr())break}else t.name=read_selector(e);e.next()}return t}function read_steps(e){const r=[];for(var t;!e.end()&&"}"!=(t=e.curr());)is.white_space(t)?e.next():(r.push(read_step(e)),e.next());return r}function read_keyframes(e){for(var r,t=Tokens.keyframes();!e.end()&&"}"!=(r=e.curr());)if(t.name.length){if("{"==r){e.next(),t.steps=read_steps(e);break}e.next()}else if(read_word(e),t.name=read_word(e),"{"==t.name){throw_error("missing keyframes name",e.info());break}return t}function read_comments(e,r={}){var t=Tokens.comment(),s=e.curr();for("#"!=s&&e.next(),e.next();!e.end()&&("*"!=(s=e.curr())||"/"!=e.curr(1));){if(t.value+=s,s=e.curr(),r.inline){if("\n"==s)return t}else if("*"==s&&"/"==e.curr(1))break;t.value+=s,e.next()}return e.next(),e.next(),t}function read_property(e){for(var r,t="";!e.end()&&":"!=(r=e.curr());)/[a-zA-Z\-@]/.test(r)?is.white_space(r)||(t+=r):throw_error("Syntax error:Bad property name.",e.info()),e.next();return t}function read_quote_block(e,r){var t,s="";for(e.next();!e.end();){if((t=e.curr())==r){if("\\"!==e.curr(-1))break;s+=t}else s+=t;e.next()}return s}function read_arguments(e){for(var r,t=[],s=[],n="";!e.end();){if(is.open_bracket(r=e.curr()))n+=skip_block(e);else if(/['"]/.test(r))n+=read_quote_block(e,r);else if("@"==r)s.length||(n=n.trimLeft()),n.length&&(s.push(Tokens.text(n)),n=""),s.push(read_func(e));else if(/[,)]/.test(r)){if(n.length&&(s.length?(n=n.trimRight()).length&&s.push(Tokens.text(n)):s.push(Tokens.text(get_text_value(n)))),t.push(s.slice()),[s,n]=[[],""],")"==r)break}else n+=r;e.next()}return t}function read_func(e){for(var r,t=Tokens.func(),s="";!e.end()&&")"!=(r=e.curr());){if("("==r){e.next(),t.name=s,t.arguments=read_arguments(e);break}s+=r,e.next()}return t}function read_value(e){var r,t=Tokens.text();const s=[];for(;!e.end();)if("\n"!=(r=e.curr())){if(/[;}]/.test(r)){t.value.length&&s.push(t),t=Tokens.text();break}"@"==r?(t.value.length&&s.push(t),t=Tokens.text(),s.push(read_func(e))):is.white_space(r)&&is.white_space(e.curr(-1))||(":"==r&&throw_error("Syntax error:Bad property name.",e.info()),t.value+=r),e.next()}else e.next();return t.value.length&&s.push(t),s.length&&s[0].value&&(s[0].value=s[0].value.trimLeft()),s}function read_selector(e){for(var r,t="";!e.end()&&"{"!=(r=e.curr());)is.white_space(r)||(t+=r),e.next();return t}function read_cond_selector(e){for(var r,t={name:"",arguments:[]};!e.end();){if("("==(r=e.curr()))e.next(),t.arguments=read_arguments(e);else{if(/[){]/.test(r))break;is.white_space(r)||(t.name+=r)}e.next()}return t}function read_psuedo(e){for(var r,t=Tokens.psuedo();!e.end()&&"}"!=(r=e.curr());)if(is.white_space(r))e.next();else{if(t.selector){if(t.styles.push(read_rule(e)),"}"==e.curr())break}else t.selector=read_selector(e);e.next()}return t}function read_rule(e){for(var r=Tokens.rule();!e.end()&&";"!=e.curr();){if(r.property.length){r.value=read_value(e);break}r.property=read_property(e),e.next()}return r}function read_cond(e){for(var r,t=Tokens.cond();!e.end()&&"}"!=(r=e.curr());){if(t.name.length)if(":"==r){var s=read_psuedo(e);s.selector&&t.styles.push(s)}else if("@"!=r||read_line(e,!0).includes(":")){if(!is.white_space(r)){var n=read_rule(e);if(n.property&&t.styles.push(n),"}"==e.curr())break}}else t.styles.push(read_cond(e));else Object.assign(t,read_cond_selector(e));e.next()}return t}function parse(e){const r=iterator(e),t=[];for(;!r.end();){var s=r.curr();if(is.white_space(s))r.next();else{if("/"==s&&"*"==r.curr(1))t.push(read_comments(r));else if("#"==s||"/"==s&&"/"==r.curr(1))t.push(read_comments(r,{inline:!0}));else if(":"==s){var n=read_psuedo(r);n.selector&&t.push(n)}else if("@"==s&&"@keyframes"===read_word(r,!0)){var i=read_keyframes(r);t.push(i)}else if("@"!=s||read_line(r,!0).includes(":")){if(!is.white_space(s)){var a=read_rule(r);a.property&&t.push(a)}}else{var o=read_cond(r);o.name.length&&t.push(o)}r.next()}}return t}function add_unit(e,r){return(...t)=>{t=t.map(remove_unit);var s=e.apply(null,t);return r&&(s=s.map(e=>e+r)),s}}function get_unit(e){if(!e)return"";var r="".trim.call(e).match(reg_match_unit);return r?r[0]:""}function remove_unit(e){var r=get_unit(e);return r?+e.replace(r,""):e}function values(e){return Array.isArray(e)?e:Object.keys(e).map(r=>e[r])}function apply_args(e,...r){return r.reduce((e,r)=>e.apply(null,values(r)),e)}function join_line(e){return(e||[]).join("\n")}function make_array(e){return Array.isArray(e)?e:[e]}function minmax(e,r,t){return Math.max(r,Math.min(t,e))}function prefix(e){return`-webkit-${e}${e}`}function only_if(e,r){return e?r:""}function memo(e,r){return(...t)=>{var s=e+t.join("-");return memo_store[s]?memo_store[s]:memo_store[s]=r.apply(null,t)}}function random(...e){var r=e.reduce((e,r)=>e.concat(r),[]);return r[Math.floor(Math.random()*r.length)]}function range(e,r,t){var s=0,n=e=>e>0&&e<1?.1:1,i=arguments.length;1==i&&([e,r]=[n(e),e]),i<3&&(t=n(e));for(var a=[];(t>0&&e<r||t<0&&e>r)&&(a.push(e),e+=t,!(s++>=1e3)););return a}function unitify(e){return(...r)=>{var t=get_unit(r[0]);return t?(r=r.map(remove_unit),add_unit(e,t).apply(null,r)):e.apply(null,r)}}function parse_grid(e){var[r,t]=(e+"").replace(/\s+/g,"").replace(/[,，xX]+/,"x").split("x").map(Number);const s=1==r||1==t?total:max,n={x:minmax(r||min,1,s),y:minmax(t||r||min,1,s)};return Object.assign({},n,{count:n.x*n.y})}function polygon(e,r){"function"==typeof arguments[0]&&(r=e,e={}),r||(r=(e=>[cos(e),sin(e)]));for(var t=e.split||120,s=e.scale||1,n=DEG*(e.start||0),i=e.deg?e.deg*DEG:PI/(t/2),a=[],o=0;o<t;++o){var c=n+i*o,[l,u]=r(c);a.push(50*l*s+50+"% "+(50*u*s+50)+"%")}return`polygon(${a.join(",")})`}function rotate(e,r,t){var s=DEG*t;return[e*cos(s)-r*sin(s),r*cos(s)+e*sin(s)]}function skip_pair(e){var r,t=e.curr();for(e.next();!e.end()&&(t+=r=e.curr(),")"!=r);)"("==r&&(t+=skip_pair(e)),e.next();return t}function skip_seperator(e){for(;!e.end()&&is_seperator(e.curr(1));)e.next()}function parse$1(e){const r=iterator(e),t=[];for(var s="";!r.end();){var n=r.curr();"("==n?s+=skip_pair(r):is_seperator(n)?(t.push(s),s="",skip_seperator(r)):s+=n,r.next()}return s&&t.push(s),t}function is_host_selector(e){return/^\:(host|doodle)/.test(e)}function is_parent_selector(e){return/^\:(container|parent)/.test(e)}function is_special_selector(e){return is_host_selector(e)||is_parent_selector(e)}function generator(e,r){var t=new Rules(e);t.compose({x:1,y:1,count:1});var{grid:s}=t.output();s&&(r=s),t.reset();for(var n=1,i=0;n<=r.x;++n)for(var a=1;a<=r.y;++a)t.compose({x:n,y:a,count:++i});return t.output()}const Tokens={func:(e="")=>({type:"func",name:e,arguments:[]}),argument:()=>({type:"argument",value:[]}),text:(e="")=>({type:"text",value:e}),comment:e=>({type:"comment",value:e}),psuedo:(e="")=>({type:"psuedo",selector:e,styles:[]}),cond:(e="")=>({type:"cond",name:e,styles:[],arguments:[]}),rule:(e="")=>({type:"rule",property:e,value:[]}),keyframes:(e="")=>({type:"keyframes",name:e,steps:[]}),step:(e="")=>({type:"step",name:e,styles:[]})},bracket_pair={"(":")","[":"]","{":"}"},is={white_space:e=>/[\s\n\t]/.test(e),line_break:e=>/\n/.test(e),open_bracket:e=>bracket_pair.hasOwnProperty(e),close_bracket_of(e){var r=bracket_pair[e];return e=>e==r},number:e=>!isNaN(e)},units=`\n % cm fr rem em ex in mm pc pt px\n vh vw vmax vmin\n deg grad rad turn\n ms s\n`,reg_match_unit=new RegExp(`(${units.trim().split(/[\s\n]+/).join("|")})$`),memo_store={},[min,max,total]=[1,16,256],{cos:cos,sin:sin,sqrt:sqrt,pow:pow,PI:PI}=Math,DEG=PI/180,shapes={circle:()=>"circle(49%)",triangle:()=>polygon({split:3,start:-90},e=>[1.1*cos(e),1.1*sin(e)+.2]),rhombus:()=>polygon({split:4}),pentagon:()=>polygon({split:5,start:54}),hexgon:()=>polygon({split:6,start:30}),hexagon:()=>polygon({split:6,start:30}),heptagon:()=>polygon({split:7,start:-90}),octagon:()=>polygon({split:8,start:22.5}),star:()=>polygon({split:5,start:54,deg:144}),diamond:()=>"polygon(50% 5%, 80% 50%, 50% 95%, 20% 50%)",cross:()=>`polygon(\n 5% 35%, 35% 35%, 35% 5%, 65% 5%,\n 65% 35%, 95% 35%, 95% 65%, 65% 65%,\n 65% 95%, 35% 95%, 35% 65%, 5% 65%\n )`,clover:(e=3)=>(4==(e=minmax(e,3,5))&&(e=2),polygon({split:240},r=>{var t=cos(e*r)*cos(r),s=cos(e*r)*sin(r);return 3==e&&(t-=.2),2==e&&(t/=1.1,s/=1.1),[t,s]})),hypocycloid(e=3){var r=1-(e=minmax(e,3,6));return polygon({scale:1/e},t=>{var s=r*cos(t)+cos(r*(t-PI)),n=r*sin(t)+sin(r*(t-PI));return 3==e&&(s=1.1*s-.6,n*=1.1),[s,n]})},astroid:()=>shapes.hypocycloid(4),infinity:()=>polygon(e=>{var r=.7*sqrt(2)*cos(e),t=pow(sin(e),2)+1;return[r/t,r*sin(e)/t]}),heart:()=>polygon(e=>rotate(1.2*(.75*pow(sin(e),3)),1.1*(cos(1*e)*(13/18)-cos(2*e)*(5/18)-cos(3*e)/18-cos(4*e)/18+.2),180)),bean:()=>polygon(e=>{var[r,t]=[pow(sin(e),3),pow(cos(e),3)];return rotate((r+t)*cos(e)*1.3-.45,(r+t)*sin(e)*1.3-.45,-90)}),bicorn:()=>polygon(e=>rotate(cos(e),pow(sin(e),2)/(2+sin(e))-.5,180)),pear:()=>polygon(e=>[sin(e),(1+sin(e))*cos(e)/1.4]),fish:()=>polygon(e=>[cos(e)-pow(sin(e),2)/sqrt(2),sin(2*e)/2]),whale:()=>polygon({split:240},e=>{var r=3.4*(pow(sin(e),2)-.5)*cos(e);return rotate(cos(e)*r+.75,sin(e)*r*1.2,180)}),bud:(e=3)=>(e=minmax(e,3,10),polygon({split:240},r=>[(1+.2*cos(e*r))*cos(r)*.8,(1+.2*cos(e*r))*sin(r)*.8]))};var Func={index:(e,r,t)=>e=>t,row:(e,r,t)=>r=>e,col:(e,r,t)=>e=>r,pick:()=>(...e)=>random(e),rand:()=>(...e)=>random(memo("range",unitify(range)).apply(null,e)),shape:()=>memo("shape",(e="",...r)=>{if(e=e.trim(),shapes[e])return shapes[e].apply(null,r)}),calc:()=>e=>new Function(`return ${e}`)()};const is_seperator=e=>/[,，\s]/.test(e);var Property={["@size"](e){var[r,t=r]=parse$1(e);return`width:${r};height:${t};`},["size"](e){return this["@size"](e)},["@min-size"](e){var[r,t=r]=parse$1(e);return`min-width:${r};min-height:${t};`},["min-size"](e){return this["@min-size"](e)},["@max-size"](e){var[r,t=r]=parse$1(e);return`max-width:${r};max-height:${t};`},["max-size"](e){return this["@max-size"](e)},["@place-absolute"]:e=>"center"!==parse$1(e)[0]?e:`\n position:absolute;top:0;bottom:0;left:0;right:0;margin:auto !important;`,["@grid"](e){var[r,t]=e.split("/").map(e=>e.trim());return{grid:parse_grid(r),size:t?this["@size"](t):""}},["@shape"]:memo("shape-property",function(e){var[r,...t]=parse$1(e);return shapes[r]?`clip-path:${shapes[r].apply(null,t)};`:""})};const is$1={even:e=>!!(e%2),odd:e=>!(e%2)};var Selector={nth:(e,r,t)=>e=>e==t,at:(e,r)=>(t,s)=>e==t&&r==s,row:(e,r)=>r=>/^(even|odd)$/.test(r)?is$1[r](e-1):r==e,col:(e,r)=>e=>/^(even|odd)$/.test(e)?is$1[e](r-1):e==r,even:(e,r,t)=>e=>is$1.even(t-1),odd:(e,r,t)=>e=>is$1.odd(t-1),random:()=>e=>Math.random()<.5};const methods=Object.getOwnPropertyNames(Math);var MathFunc=methods.reduce((expose,n)=>(expose[n]=(()=>(...args)=>"number"==typeof Math[n]?Math[n]:Math[n].apply(null,args.map(eval))),expose),{});class Rules{constructor(e){this.tokens=e,this.rules={},this.props={},this.keyframes={},this.grid=null,this.reset()}reset(){this.styles={host:"",container:"",cells:"",keyframes:""}}add_rule(e,r){var t=this.rules[e];t||(t=this.rules[e]=[]),t.push.apply(t,make_array(r))}pick_func(e){return Func[e]||MathFunc[e]}compose_aname(...e){return e.join("-")}compose_selector(e,r=""){return`.cell:nth-of-type(${e})${r}`}compose_argument(e,r){var t=e.map(e=>{if("text"==e.type)return e.value;if("func"==e.type){var t=this.pick_func(e.name.substr(1));if(t){var s=e.arguments.map(e=>this.compose_argument(e,r));return apply_args(t,r,s)}}});return t.length>=2?t.join(""):t[0]}compose_value(e,r){return e.reduce((e,t)=>{switch(t.type){case"text":e+=t.value;break;case"func":var s=this.pick_func(t.name.substr(1));if(s){var n=t.arguments.map(e=>this.compose_argument(e,r));e+=apply_args(s,r,n)}}return e},"")}compose_rule(e,r,t){var s=e.property,n=this.compose_value(e.value,r),i=`${s}:${n};`;if("transition"==s&&(this.props.has_transition=!0),"clip-path"==s&&(i=prefix(i),i+=";overflow:hidden;"),/^animation(\-name)?$/.test(s)&&(this.props.has_animation=!0,r.count>1)){var{count:a}=r;switch(s){case"animation-name":i=`${s}:${this.compose_aname(n,a)};`;break;case"animation":var o=(n||"").split(/\s+/);o[0]=this.compose_aname(o[0],a),i=`${s}:${o.join(" ")};`}}if(Property[s]){var c=Property[s](n);"@grid"!==s?i=c:is_host_selector(t)&&(this.grid=c.grid,i=c.size||"")}return i}compose(e,r){(r||this.tokens).forEach((r,t)=>{if(r.skip)return!1;switch(r.type){case"rule":this.add_rule(this.compose_selector(e.count),this.compose_rule(r,e));break;case"psuedo":r.selector.startsWith(":doodle")&&(r.selector=r.selector.replace(/^\:+doodle/,":host"));var s=is_special_selector(r.selector);s&&(r.skip=!0);var n=r.styles.map(t=>this.compose_rule(t,e,r.selector)),i=s?r.selector:this.compose_selector(e.count,r.selector);this.add_rule(i,n);break;case"cond":var a=Selector[r.name.substr(1)];if(a){var o=r.arguments.map(r=>this.compose_argument(r,e));apply_args(a,e,o)&&this.compose(e,r.styles)}break;case"keyframes":this.keyframes[r.name]||(this.keyframes[r.name]=(()=>`\n ${join_line(r.steps.map(r=>`\n ${r.name}{${join_line(r.styles.map(r=>this.compose_rule(r,e)))}}`))}`))}})}output(){return Object.keys(this.rules).forEach((e,r)=>{if(is_parent_selector(e))this.styles.container+=`\n .container{${join_line(this.rules[e])}}`;else{var t=is_host_selector(e)?"host":"cells";this.styles[t]+=`\n ${e}{${join_line(this.rules[e])}}`}Object.keys(this.keyframes).forEach(e=>{var t=this.compose_aname(e,r+1);this.styles.keyframes+=`\n ${only_if(0==r,`@keyframes ${e}{${this.keyframes[e]()}}`)}@keyframes ${t}{${this.keyframes[e]()}}`})}),{props:this.props,styles:this.styles,grid:this.grid}}}const basic=`\n:host{display:block;visibility:visible;width:1em;height:1em;}.container{position:relative;width:100%;height:100%;display:grid;}.cell{position:relative;line-height:1;box-sizing:border-box;display:flex;justify-content:center;align-items:center;}`;class Doodle extends HTMLElement{constructor(){super(),this.doodle=this.attachShadow({mode:"open"})}connectedCallback(){setTimeout(()=>{var e;if(!this.innerHTML.trim())return!1;try{var r=parse(this.innerHTML);this.grid_size=parse_grid(this.getAttribute("grid")),(e=generator(r,this.grid_size)).grid&&(this.grid_size=e.grid)}catch(e){throw this.innerHTML="",new Error(e)}this.build_grid(e)})}build_grid(e){const{has_transition:r,has_animation:t}=e.props,{keyframes:s,host:n,container:i,cells:a}=e.styles;this.doodle.innerHTML=`\n<style>${basic}</style><style class="style-keyframes">${s}</style><style class="style-container">${this.style_size()}${n}${i}</style><style class="style-cells">${r||t?"":a}</style><div class="container">${this.html_cells()}</div>`,(r||t)&&setTimeout(()=>{this.set_style(".style-cells",a)},50)}style_size(){return`\n .container{grid-template-rows:repeat(${this.grid_size.x}, 1fr);grid-template-columns:repeat(${this.grid_size.y}, 1fr);}`}html_cells(){return'<div class="cell"></div>'.repeat(this.grid_size.count)}set_style(e,r){const t=this.shadowRoot.querySelector(e);t&&(t.styleSheet?t.styleSheet.cssText=r:t.innerHTML=r)}update(e){if(!e)return!1;this.grid_size||(this.grid_size=parse_grid(this.getAttribute("grid")));const r=generator(parse(e),this.grid_size);if(r.grid){var{x:t,y:s}=r.grid;if(this.grid_size.x!==t||this.grid_size.y!==s)return Object.assign(this.grid_size,r.grid),this.build_grid(r);Object.assign(this.grid_size,r.grid)}else{var n=parse_grid(this.getAttribute("grid")),{x:t,y:s}=n;if(this.grid_size.x!==t||this.grid_size.y!==s)return Object.assign(this.grid_size,n),this.build_grid(generator(parse(e),this.grid_size))}this.set_style(".style-keyframes",r.styles.keyframes),this.set_style(".style-container",this.style_size()+r.styles.host+r.styles.container),this.set_style(".style-cells",r.styles.cells),this.innerHTML=e}refresh(){this.update(this.innerHTML)}get grid(){return Object.assign({},this.grid_size)}set grid(e){this.setAttribute("grid",e),this.connectedCallback()}static get observedAttributes(){return["grid"]}attributeChangedCallback(e,r,t){"grid"==e&&r&&r!==t&&(this.grid_size=t)}}customElements.define("css-doodle",Doodle)});